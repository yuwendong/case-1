<!DOCTYPE html>
<html lang="en">
<head>
	<title>情感分析</title>
	<meta charset="utf-8" />
    <!-- Bootstrap core CSS -->
    <link href="../../static/moodlens/js/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/moodlens/css/toggle_switch.css">
    <style>
    #vertical-ticker {
        overflow: auto;
        margin-left: 1px;
        margin-top: 2px;
        padding: 0;
        -webkit-box-shadow: 0 1px 3px rgba(0,0,0, .4);
    }
    #togglecount{
        width: 200px;
        position: absolute;
        top: 25px;
        left: 90px;
        z-index: 1000;
    }
    </style>
    <script src="../../static/moodlens/js/jquery.min.js"></script>
    <script src="../../static/moodlens/js/highstock.js"></script>
    <script src="../../static/moodlens/js/exporting.js"></script>
    <script src="../../static/moodlens/js/jquery.tagcanvas.min.js"></script>
    <script src="../../static/moodlens/js/jquery.totemticker.js"></script>
    
</head>
<body>
        <div class="container">
            <div class="row">
                <hr class="soften">
                <div class="col-lg-2">
                     <button type="button" class="btn btn-lg btn-warning btn-block">话题</button>
                </div>
                <div class="col-lg-2">
                </div>
                <div class="col-lg-1">
                    <button type="button" class="btn btn-lg btn-primary btn-block">微博</button>
                </div>
                <div class="col-lg-1">
                </div>
                <div class="col-lg-1">
                    <button type="button" class="btn btn-lg btn-primary btn-block">新闻</button>
                </div>
                <div class="col-lg-1">
                </div>
                <div class="col-lg-1">
                    <button type="button" class="btn btn-lg btn-primary btn-block">博客</button>
                </div>
                <div class="col-lg-1">
                </div>
                <div class="col-lg-1">
                    <button type="button" class="btn btn-lg btn-primary btn-block">论坛</button>
                </div>
            </div>
            <hr class="soften">

            <!--主体部分开始-->
            <!--情绪走势图-->
            <div class="row">
                <div class="col-lg-12">
                    <div class="control-group" id="togglecount">
                        <div class="controls btn switch switch-two">
                            <input id="relative" name="view" type="radio" checked>
                            <label for="relative" onclick="load_relative();">相对比例</label>

                            <input id="absolute" name="view" type="radio">    
                            <label for="absolute" onclick="load_absolute();">绝对数量</label>                       
                            <span class="slide-button btn btn-success"></span>
                        </div>
                    </div>
                    <div id="line_container" style="height:500px;"></div>
                </div>
                  
            </div>
            <!--饼图和词云-->
            <div class="row">
                <div class="col-lg-6" >
                    <div id="pie" style="height:300px;margin-top:50px;"></div>
                </div>
                
                <div class="col-lg-6" >
                    <div id="wordcloud" style="height:300px;">
                         <canvas height="300px" id="myCanvas" style="margin-left:100px;">
                            <p>Anything in here will be replaced on browsers that support the canvas element</p>
                        </canvas>
                        <div id="tags_div">
                            <ul id="tags_ul"><li><a style="font-size:1ex">关键词云数据为空</a></li></ul>
                        </div>
                        <button type="button" class="btn btn-primary" id="download1" onclick="download1();" style="float:right;">下载图片</button>
                    </div>
                    
                </div>      
            </div>
            <div class="row">
            <div id="weibo_container" class="col-lg-12">
                <p><span class="label label-info" id="event_title"></span>
                   <span class="label label-success">关键微博列表</span><!--a href="#" id="ticker-previous">向上滚动</a> / <a href="#" id="ticker-next">向下滚动</a> / <a id="stop" href="#">停止滚动</a> / <a id="start" href="#">开始滚动</a--><!--input type="button" class="btn5" onclick="javascript:exportExcel();" value="导出课表"--></p>
                    <div id="TopN" style="height:300px;overflow-x: auto; overflow-y: auto;">
                        <ul id="vertical-ticker"> 
                        </ul>
                        
                    </div>
                </div>
            </div>
        </div>
            

<script>
  //数据接受或定义处
  var max_word_size = 10;
  var min_word_size = 1;
  var oopts = {textHeight: 25,maxSpeed: 0.03,decel: 0.98,depth: 0.92,outlineColour: '#f6f',outlineThickness: 3,pulsateTo: 0.2,pulsateTime: 0.5,wheelZoom: false,textColour:'#00f',shadow:'#ccf',minBrightness:0.2,shadowBlur:3,weight:true,weightMode:'both'};
  //简单的假数据，只为显示
  pie_data=[['愤怒',12345],['悲伤',12345],['高兴',12345]];
  cloud_data={'钓鱼岛':12345,'京东':34567,'北航':26535,'奶粉':14524};
  weibo_data=[{'sentiment':2,'user':'薛蛮子','weibo_link':'www.weibo.com/23525623','timestamp':1398316046,'reposts_count':23,'text':"续前。将微博打拐、免费午餐和大病医保进行到底。我会一如既往地支持青年人、尤其是大学生们创业，做好我的老本行天使投资，帮青年人实现他们的创业梦、中国梦。我会一如既往地坚持参加微公益，让尽可能多的弱势群体得到应有的救助。我会汲取教训，坚决拒绝转发、评论、传播任何未经核实的信息，续"},{'sentiment':2,'user':'薛蛮子','weibo_link':'www.weibo.com/23525623','timestamp':1398316046,'reposts_count':23,'text':"续前。将微博打拐、免费午餐和大病医保进行到底。我会一如既往地支持青年人、尤其是大学生们创业，做好我的老本行天使投资，帮青年人实现他们的创业梦、中国梦。我会一如既往地坚持参加微公益，让尽可能多的弱势群体得到应有的救助。我会汲取教训，坚决拒绝转发、评论、传播任何未经核实的信息，续"},{'sentiment':2,'user':'薛蛮子','weibo_link':'www.weibo.com/23525623','timestamp':1398316046,'reposts_count':23,'text':"续前。将微博打拐、免费午餐和大病医保进行到底。我会一如既往地支持青年人、尤其是大学生们创业，做好我的老本行天使投资，帮青年人实现他们的创业梦、中国梦。我会一如既往地坚持参加微公益，让尽可能多的弱势群体得到应有的救助。我会汲取教训，坚决拒绝转发、评论、传播任何未经核实的信息，续"},{'sentiment':2,'user':'薛蛮子','weibo_link':'www.weibo.com/23525623','timestamp':1398316046,'reposts_count':23,'text':"续前。将微博打拐、免费午餐和大病医保进行到底。我会一如既往地支持青年人、尤其是大学生们创业，做好我的老本行天使投资，帮青年人实现他们的创业梦、中国梦。我会一如既往地坚持参加微公益，让尽可能多的弱势群体得到应有的救助。我会汲取教训，坚决拒绝转发、评论、传播任何未经核实的信息，续"},{'sentiment':2,'user':'薛蛮子','weibo_link':'www.weibo.com/23525623','timestamp':1398316046,'reposts_count':23,'text':"续前。将微博打拐、免费午餐和大病医保进行到底。我会一如既往地支持青年人、尤其是大学生们创业，做好我的老本行天使投资，帮青年人实现他们的创业梦、中国梦。我会一如既往地坚持参加微公益，让尽可能多的弱势群体得到应有的救助。我会汲取教训，坚决拒绝转发、评论、传播任何未经核实的信息，续"}];
   //启动处
  $(document).ready(function(){  
        display_emotion_pie(pie_data);
        redraw_tagcanvas();
        chg_tagcloud(cloud_data);
        //display_vertical_list();
        chg_weibos(weibo_data);
        display_emotion_line();
        
    })
   //情绪走势图绘制
  function display_emotion_line(){
        Highcharts.setOptions({
            global: {
                useUTC: false
            }
        });
        var chart_obj = $('#line_container').highcharts({
            chart: {
                type: 'line',//spline,
                animation: Highcharts.svg, // don't animate in old IE
                marginRight: 10,
                events: {
                    load: function() {
                        var during = DURING_INTERGER;
                        var begin_ts = START_TS;
                        var end_ts = END_TS;
                        var total_nodes = (end_ts - begin_ts) / during;
                        var times_init = 0;

                        init_statistics(end_ts, end_ts - begin_ts);
                              
                        pull_emotion_count('global', total_nodes, times_init, begin_ts, during, this.series[0], this.series[1], this.series[2], this.series[3], this.series[4], this.series[5], this.series[6], this.series[7], this.series[8]);
                    }
                }
            },
            title : {
                text: '微博情绪走势图'
            },

            rangeSelector: {
                selected: 4,
                inputEnabled: false,
                buttons: [{
                    type: 'week',
                    count: 1,
                    text: '1w'
                }, {
                    type: 'month',
                    count: 1,
                    text: '1m'
                }, {
                    type: 'month',
                    count: 3,
                    text: '3m'
                }]
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: '时间'
                },
                type: 'datetime',
                tickPixelInterval: 150
            },
            yAxis: {
                min: 0,
                title: {
                    text: '微 博 条 数'
                },
            },
            tooltip: {
                valueDecimals: 2,
                xDateFormat: '%Y-%m-%d %H:%M'
            },
            legend: {
               layout: 'vertical',
                align: 'right',
                verticalAlign: 'top',
                x: -20,
                y: 0,
                borderWidth: 1,
                enabled: true
            },
            exporting: {
                enabled: true
            },
            //series123.addPoint([ts * 1000, happy_emotion_ratio], true, isShift);
            //series456789.addPoint({'x': x, 'title': angry_title, 'text': angry_text, 'emotion': 'angry', 'events': {'click': flagClick}}, true, isShift);
            series: [{
                name: '高兴',
                data: [],
                id: 'happy',
                color: '#006600',
                marker : {
                    enabled : false,    
                }
            },{
                name: '愤怒',
                id: 'angry',
                color: '#FF0000',
                marker : {
                    enabled : false,    
                }
            },{
                name: '悲伤',
                data: [],
                id: 'sad',
                color: '#000099',
                marker : {
                    enabled : false,    
                }
            },{
                name: '相对高兴拐点',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'happy',
                shape : 'circlepin',
                width : 16,
                color: '#006600'
            },{
                name: '相对愤怒拐点',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'angry',
                shape : 'circlepin',
                width : 16,
                color: '#FF0000'
            },{
                name: '相对悲伤拐点',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'sad',
                shape : 'circlepin',
                width : 16,
                color: '#000099'
            },{
                name: '绝对高兴拐点',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'happy',
                shape : 'circlepin',
                width : 16,
                color: '#006600',
                visible:false
            },{
                name: '绝对愤怒拐点',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'angry',
                shape : 'circlepin',
                width : 16,
                color: '#FF0000',
                visible:false
            },{
                name: '绝对悲伤拐点',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'sad',
                shape : 'circlepin',
                width : 16,
                color: '#000099',
                visible:false
            }]
        });
    }
      //情绪饼图绘制 数据格式：[['高兴',happy_count],['愤怒',angry_count],['悲伤',sad_count]]
     
  function display_emotion_pie(data){
        Highcharts.setOptions({
            colors: ['#006600', '#FF0000', '#000099']
        });
        // Build the chart
        $('#pie').highcharts({
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
            },
            title: {
                text: '微博情绪饼图',
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        formatter:function(){
                            return '<b>'+this.point.name+'</b>'+this.percentage.toFixed(2)+'%';}

                    },
                    showInLegend: true
                }
            },
            navigation: {
                buttonOptions: {
                    verticalAlign: 'bottom',
                    y: -20
                }
            },
            series: [{
                type: 'pie',
                name: '情绪数值',
                data: data
            }]
        });
    }
    //绘制词云
    //数据格式是cloudlist
   //数据添加方式$("#tags_ul").append("<li><a href='#tag_cloud_div' style=\"font-size:"+ defscale(cloud_list[i][0], min_count, max_count, min_word_size, max_word_size) +"ex\">"+ cloud_list[i][1] +"</a></li>");
   function redraw_tagcanvas() {
        if(!$('#myCanvas').tagcanvas(oopts,'tags_div')) {
            $('#myCanvas').hide();
        }
    }
    /*function redraw_tagcanvas() {
        if(!$('#myCanvas').tagcanvas({
          textColour: '#ff0000',
          outlineColour: '#ff00ff',
          reverse: true,
          depth: 0.8,
          maxSpeed: 0.05
        },'tags_div')) {
          // something went wrong, hide the canvas container
          $('#tags_div').hide();
        }
      }*/
    function defscale(count, mincount, maxcount, minsize, maxsize){
      if(maxcount == mincount){
        return (maxsize + minsize) / 2
      }else{
        return minsize + (maxsize - minsize) * Math.pow((count / (maxcount - mincount)), 2)
      }
    }
    
    function chg_tagcloud(data) {/*数据的添加格式为{'':,'':,'':s,}*/
        $("#tags_ul").empty();
        var cloud_list = [];
        var max_count = 0;
        var min_count = 0;
        for (var i in data) {
            if(max_count < parseInt(data[i])){
                max_count = parseInt(data[i]);
            }
            if(min_count > parseInt(data[i])){
                min_count = parseInt(data[i]);
            }
            cloud_list.push([parseInt(data[i]), i]);
        }
        console.log(cloud_list);
        for (var i=0;i<cloud_list.length;i++) {
            $("#tags_ul").append("<li><a href='#tag_cloud_div' style=\"font-size:"+ defscale(cloud_list[i][0], min_count, max_count, min_word_size, max_word_size) +"ex\">"+ cloud_list[i][1] +"</a></li>");
        }
        redraw_tagcanvas();
    }  
    ////词云的下载
    function download1(){
        var canvas = document.getElementById('myCanvas');

        var type = 'png';
        var imgData = canvas.toDataURL(type);    

        var _fixType = function(type) {
            type = type.toLowerCase().replace(/jpg/i, 'jpeg');
            var r = type.match(/png|jpeg|bmp|gif/)[0];
            return 'image/' + r;
        };
   
        // 加工image data，替换mime type
        imgData = imgData.replace(_fixType(type),'image/octet-stream');

        var saveFile = function(data, filename){
            var save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a');
            save_link.href = data;
            save_link.download = filename;
   
            var event = document.createEvent('MouseEvents');
            event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            save_link.dispatchEvent(event);
        };
   
        // 下载后的问题名
        var filename = 'wordcloud' + (new Date()).getTime() + '.' + type;
        // download
        saveFile(imgData,filename);
        };
        function download2(){
             var canvas = document.getElementById('myCanvas');
             var dataURL = canvas.toDataURL();    
             window.open('', '_blank').location.href=dataURL;
              };
    

    //绘制关键微博的展示框
    function display_vertical_list(){
        $('#vertical-ticker').totemticker({
            row_height  :   '100px',
            next        :   '#ticker-next',
            previous    :   '#ticker-previous',
            stop        :   '#stop',
            start       :   '#start',
            mousestop   :   true,
        });
    };
    
    function chg_weibos(data){
        var html = "";
        var emotion_content = ['happy', 'angry', 'sad'];
        for(var i=0;i<data.length;i+=1){
            var emotion = emotion_content[data[i]['sentiment']-1];
            var name = data[i]['user'];
            var user_link = 'http://weibo.com/u/'+data[i]['user'];
            var text = data[i]['text'];
            var weibo_link = data[i]['weibo_link'];
            var time = Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', parseInt(data[i]['timestamp']) * 1000);
            var repost_count = data[i]['reposts_count'];
            var retweeted_text = 'None';
            html += "<li><div class=\"chartclient-annotation-letter\"><img src='/static/img/" + emotion + "_thumb.gif'></div>"; 
            html += "<div class=\"chartclient-annotation-title\"><a href='" + user_link + "' target='_blank' >" + name + "</a> 发布 </div>";
            html += "<div class=\"chartclient-annotation-content\"><a href='" + weibo_link + "' target='_blank' >" + text + "</a></div>";
            if(retweeted_text != 'None'){
                html += "<div class=\"chartclient-annotation-content\">" + retweeted_text + "</div>";
            }
            html += "<div class=\"chartclient-annotation-date\"> " + time + "<span style=\"float:right\"> 转发数：" +  repost_count + "</span></div></li>";
        }

        $("#vertical-ticker").append(html);
        //display_vertical_list();
    }

    function isEmptyObject(obj){
        for ( var name in obj ) { 
            return false;
        } 
        return true; 
    }   
   //网页的动态更新
   function init_statistics(end_ts, duration){
        //end_ts为截止时间戳, duration为整个时间段的秒数
        
        $.ajax({
            url: "/moodlens/weibos_data/global/global/?ts=" + end_ts + "&during=" + duration + '&limit=' + WEIBOS_LIMIT,
            type: "GET",
            dataType:"json",
            success: function(data){
                $("#vertical-ticker").empty();
                var happy_length = data['happy'].length;
                var sad_length = data['sad'].length;
                var angry_length = data['angry'].length;
                var total_length  = happy_length + sad_length + angry_length;
                if(total_length > 0) {
                    var weibos = [];
                    for(var e in emotion_keys){
                        for(var i=0; i< data[emotion_keys[e]].length; i+=1)
                            weibos.push(data[emotion_keys[e]][i]);
                    }
                    chg_weibos(weibos);
                }
                else{
                    $("#vertical-ticker").empty();
                    $("#vertical-ticker").append("关键微博为空！");
                }
            }
        });
        $.ajax({
            url: "/moodlens/keywords_data/global/?ts=" + end_ts + "&during=" + duration + "&limit=" + KEYWORDS_LIMIT,
            type: "GET",
            dataType:"json",
            success: function(data){
                if(data=='search function undefined'){
                    $("#tags_ul").empty();
                    $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                    redraw_tagcanvas();
                }
                else{
                    if(isEmptyObject(data['happy']) && isEmptyObject(data['angry']) && isEmptyObject(data['sad'])){
                        $("#tags_ul").empty();
                        $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                        redraw_tagcanvas();
                    }
                    else{
                        for(var e in emotion_keys){
                            chg_tagcloud(data[emotion_keys[e]]); 
                        }
                    }
                }
            }
        });
        $.ajax({
            url: "/moodlens/data/global/?ts=" + end_ts + "&during=" + duration,
            type: "GET",
            dataType:"json",
            success: function(data){
                var happy_emotion_count = data['happy'][1];
                var angry_emotion_count = data['angry'][1];
                var sad_emotion_count = data['sad'][1];
                var total_count = parseInt(happy_emotion_count) + parseInt(angry_emotion_count) + parseInt(sad_emotion_count);
                chg_emotion_pie([happy_emotion_count, angry_emotion_count, sad_emotion_count, total_count]);
            }
        })
    }

    function pull_emotion_count(area_type, total_days, times, begin_ts, during, series1, series2, series3, series4, series5, series6,series7,series8,series9){
        if(times > total_days){
            get_peaks(series4, series5, series6, during);
            get_absolute_peaks(series7, series8, series9, during);
            click_flag=true;
            setInterval("refresh_page()", 60000);
            return;
        }
        
        var ts = begin_ts + times * during;
        $.ajax({
            url: "/moodlens/data/" + area_type + "/" + "?ts=" + ts + '&during=' + during,
            type: "GET",
            dataType:"json",
            success: function(data){
                var isShift = false;
                var happy_emotion_count = data['happy'][1];
                var angry_emotion_count = data['angry'][1];
                var sad_emotion_count = data['sad'][1];

                var total_emotion_count = happy_emotion_count + angry_emotion_count + sad_emotion_count;
                if(total_emotion_count > 0){
                    var happy_emotion_ratio = parseInt(happy_emotion_count * 10000 / total_emotion_count) / 10000.0;
                    var angry_emotion_ratio = parseInt(angry_emotion_count * 10000 / total_emotion_count) / 10000.0;
                    var sad_emotion_ratio = parseInt(sad_emotion_count * 10000 / total_emotion_count) / 10000.0;
                    series1.addPoint([ts * 1000, happy_emotion_ratio], true, isShift);
                    series2.addPoint([ts * 1000, angry_emotion_ratio], true, isShift);
                    series3.addPoint([ts * 1000, sad_emotion_ratio], true, isShift);

                    emotion_ratio[ts * 1000] = [happy_emotion_ratio, angry_emotion_ratio, sad_emotion_ratio, total_emotion_count];
                    emotion_absolute[ts*1000]=[happy_emotion_count, angry_emotion_count, sad_emotion_count, total_emotion_count];

                    happy_absolute.push([ts * 1000, happy_emotion_count]);
                    angry_absolute.push([ts * 1000, angry_emotion_count]);
                    sad_absolute.push([ts * 1000, sad_emotion_count]);

                    happy_ratio.push([ts * 1000, happy_emotion_ratio]);
                    angry_ratio.push([ts * 1000, angry_emotion_ratio]);
                    sad_ratio.push([ts * 1000, sad_emotion_ratio]);

                    happy_list.push(happy_emotion_ratio);
                    angry_list.push(angry_emotion_ratio);
                    sad_list.push(sad_emotion_ratio);
                    ts_list.push(ts);

                    happy_alist.push(happy_emotion_count);
                    angry_alist.push(angry_emotion_count);
                    sad_alist.push(sad_emotion_count);
                    ts_alist.push(ts);
                }
                else{
                    emotion_ratio[ts * 1000] = [0, 0, 0, 0];
                    emotion_absolute[ts*1000]= [0, 0, 0, 0];
                }
                times++;
                pull_emotion_count(area_type, total_days, times, begin_ts, during, series1, series2, series3, series4, series5, series6, series7,series8, series9);
            }
        });
        //预防用户在series加载完毕前，变换相对绝对。
        document.getElementById("relative").checked="checked";
    }

    function get_absolute_peaks(series7, series8, series9, during){
        $.ajax({
            url: "/moodlens/emotionpeak/?lis=" + happy_alist.join(',') + "&ts=" + ts_alist + '&during=' + during + "&emotion=happy",
            type: "GET",
            dataType:"json",
            success: function(data){
              if ( data != 'Null Data'){
              var isShift = false;
              for(var i in data){
                var x = data[i]['ts'];
                var title = data[i]['title'];
                var happy_title = title;
                
                var text = data[i]['text'];
                var happy_text = text;
                
                var flagClick = function(event){
                    var click_ts = this.x / 1000;
                    var emotion = this.emotion;
                    var title = this.title;
                    $.ajax({
                        url: "/moodlens/weibos_data/" + emotion + "/global/?ts=" + click_ts + '&limit=' + WEIBOS_LIMIT + "&during=" + during,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            $("#vertical-ticker").empty();
                            $("#event_title").html(title);
                            if(data[emotion].length>0){
                                chg_weibos(data[emotion]);
                            }
                            else{
                                $("#vertical-ticker").append(" 关键微博为空！");
                            }
                        }
                    });
                    $.ajax({
                        url: "/moodlens/keywords_data/global/?ts=" + click_ts + "&emotion=" + emotion + "&limit=" + KEYWORDS_LIMIT + "&during=" + during,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            if(data=='search function undefined'){
                                $("#tags_ul").empty();
                                $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                redraw_tagcanvas();
                            }
                            else{
                                if(isEmptyObject(data[emotion])){
                                    $("#tags_ul").empty();
                                    $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                    redraw_tagcanvas();
                                }
                                else{
                                    chg_tagcloud(data[emotion]);
                                }
                            }
                        }
                    });
                    chg_emotion_pie(emotion_absolute[this.x]);     
                }
                series7.addPoint({'x': x, 'title': happy_title, 'text': happy_text, 'emotion': 'happy', 'events': {'click': flagClick}}, true, isShift);
              }
            }
        }
        })
        $.ajax({
            url: "/moodlens/emotionpeak/?lis=" + angry_alist.join(',') + "&ts=" + ts_alist + '&during=' + during + "&emotion=angry",
            type: "GET",
            dataType:"json",
            success: function(data){
              if ( data != 'Null Data'){
              var isShift = false;
              for(var i in data){
                var x = data[i]['ts'];
                var title = data[i]['title'];
                //var happy_title = title['happy'];
                var angry_title = title;
                //var sad_title = title['sad'];
                var text = data[i]['text'];
                //var happy_text = text['happy'];
                var angry_text = text;
                //var sad_text = text['sad'];
                var flagClick = function(event){
                    var click_ts = this.x / 1000;
                    var emotion = this.emotion;
                    var title = this.title;
                    $.ajax({
                        url: "/moodlens/weibos_data/" + emotion + "/global/?ts=" + click_ts + '&limit=' + WEIBOS_LIMIT + "&during=" + during,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            $("#vertical-ticker").empty();
                            $("#event_title").html(title);
                            if(data[emotion].length>0){
                                chg_weibos(data[emotion]);
                            }
                            else{
                                $("#vertical-ticker").append(" 关键微博为空！");
                            }
                        }
                    });
                    $.ajax({
                        url: "/moodlens/keywords_data/global/?ts=" + click_ts + "&emotion=" + emotion + "&limit=" + KEYWORDS_LIMIT + "&during=" + during,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            if(data=='search function undefined'){
                                $("#tags_ul").empty();
                                $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                redraw_tagcanvas();
                            }
                            else{
                                if(isEmptyObject(data[emotion])){
                                    $("#tags_ul").empty();
                                    $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                    redraw_tagcanvas();
                                }
                                else{
                                    chg_tagcloud(data[emotion]);
                                }
                            }
                        }
                    });
                    chg_emotion_pie(emotion_absolute[this.x]);     
                }
                series8.addPoint({'x': x, 'title': angry_title, 'text': angry_text, 'emotion': 'angry', 'events': {'click': flagClick}}, true, isShift);
              }
            }
        }
        })
        $.ajax({
            url: "/moodlens/emotionpeak/?lis=" + sad_alist.join(',') + "&ts=" + ts_alist + '&during=' + during + "&emotion=sad",
            type: "GET",
            dataType:"json",
            success: function(data){
              if ( data != 'Null Data'){
              var isShift = false;
              for(var i in data){
                var x = data[i]['ts'];
                var title = data[i]['title'];
                //var happy_title = title['happy'];
                //var angry_title = title['angry'];
                var sad_title = title;
                var text = data[i]['text'];
                //var happy_text = text['happy'];
                //var angry_text = text['angry'];
                var sad_text = text;
                var flagClick = function(event){
                    var click_ts = this.x / 1000;
                    var emotion = this.emotion;
                    var title = this.title;
                    $.ajax({
                        url: "/moodlens/weibos_data/" + emotion + "/global/?ts=" + click_ts + '&limit=' + WEIBOS_LIMIT + "&during=" + during,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            $("#vertical-ticker").empty();
                            $("#event_title").html(title);
                            if(data[emotion].length>0){
                                chg_weibos(data[emotion]);
                            }
                            else{
                                $("#vertical-ticker").append(" 关键微博为空！");
                            }
                        }
                    }); 
                    $.ajax({
                        url: "/moodlens/keywords_data/global/?ts=" + click_ts + "&emotion=" + emotion + "&limit=" + KEYWORDS_LIMIT + "&during=" + during,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            if(data=='search function undefined'){
                                $("#tags_ul").empty();
                                $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                redraw_tagcanvas();
                            }
                            else{
                                if(isEmptyObject(data[emotion])){
                                    $("#tags_ul").empty();
                                    $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                    redraw_tagcanvas();
                                }
                                else{
                                    chg_tagcloud(data[emotion]);
                                }
                            }
                        }
                    });
                    chg_emotion_pie(emotion_absolute[this.x]);     
                }
                series9.addPoint({'x': x, 'title': sad_title, 'text': sad_text, 'emotion': 'sad', 'events': {'click': flagClick}}, true, isShift);
              }

            }
        }
        })
    }

    function get_peaks(series4, series5, series6, during){

        $.ajax({
            url: "/moodlens/emotionpeak/?lis=" + happy_list.join(',') + "&ts=" + ts_list + '&during=' + during + "&emotion=happy",
            type: "GET",
            dataType:"json",
            success: function(data){
              if ( data != 'Null Data'){
              var isShift = false;
              for(var i in data){
                var x = data[i]['ts'];
                var title = data[i]['title'];
                var happy_title = title;

                var text = data[i]['text'];
                var happy_text = text;
                var flagClick = function(event){
                    var click_ts = this.x / 1000;
                    var emotion = this.emotion;
                    var title = this.title;
                    $.ajax({
                        url: "/moodlens/weibos_data/" + emotion + "/global/?ts=" + click_ts + "&during=" + during + '&limit=' + WEIBOS_LIMIT,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            $("#vertical-ticker").empty();
                            $("#event_title").html(title);
                            if(data[emotion].length>0){
                                chg_weibos(data[emotion]);
                            }
                            else{
                                $("#vertical-ticker").append("关键微博为空！");
                            }
                        }
                    });
                    $.ajax({
                        url: "/moodlens/keywords_data/global/?ts=" + click_ts + "&emotion=" + emotion+"&limit=" + KEYWORDS_LIMIT + "&during=" + during,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            if(data=='search function undefined'){
                                $("#tags_ul").empty();
                                $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                redraw_tagcanvas();
                            }
                            else{
                                if(isEmptyObject(data[emotion])){
                                    $("#tags_ul").empty();
                                    $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                    redraw_tagcanvas();
                                }
                                else{
                                    chg_tagcloud(data[emotion]);
                                }
                            }
                        }
                    });
                    chg_emotion_pie(emotion_absolute[this.x]);     
                }
                series4.addPoint({'x': x, 'title': happy_title, 'text': happy_text, 'emotion': 'happy', 'events': {'click': flagClick}}, true, isShift);
              }
            }
        }
        });
        $.ajax({
            url: "/moodlens/emotionpeak/?lis=" + angry_list.join(',') + "&ts=" + ts_list + '&during=' + during + "&emotion=angry",
            type: "GET",
            dataType:"json",
            success: function(data){
              if ( data != 'Null Data'){
              var isShift = false;
              for(var i in data){
                var x = data[i]['ts'];
                var title = data[i]['title'];
                //var happy_title = title['happy'];
                var angry_title = title;
                //var sad_title = title['sad'];
                var text = data[i]['text'];
                //var happy_text = text['happy'];
                var angry_text = text;
                //var sad_text = text['sad'];
                var flagClick = function(event){
                    var click_ts = this.x / 1000;
                    var emotion = this.emotion;
                    var title = this.title;
                    $.ajax({
                        url: "/moodlens/weibos_data/" + emotion + "/global/?ts=" + click_ts + "&during=" + during + '&limit=' + WEIBOS_LIMIT,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            $("#vertical-ticker").empty();
                            $("#event_title").html(title);
                            if(data[emotion].length>0){
                                chg_weibos(data[emotion]);
                            }
                            else{
                                $("#vertical-ticker").append("关键微博为空！");
                            }
                        }
                    });
                    $.ajax({
                        url: "/moodlens/keywords_data/global/?ts=" + click_ts + "&emotion=" + emotion+"&limit=" + KEYWORDS_LIMIT + "&during=" + during,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            if(data=='search function undefined'){
                                $("#tags_ul").empty();
                                $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                redraw_tagcanvas();
                            }
                            else{
                                if(isEmptyObject(data[emotion])){
                                    $("#tags_ul").empty();
                                    $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                    redraw_tagcanvas();
                                }
                                else{
                                    chg_tagcloud(data[emotion]);
                                }
                            }
                        }
                    });
                    chg_emotion_pie(emotion_absolute[this.x]);     
                }
                series5.addPoint({'x': x, 'title': angry_title, 'text': angry_text, 'emotion': 'angry', 'events': {'click': flagClick}}, true, isShift);
              }
            }
        }
        })
        $.ajax({
            url: "/moodlens/emotionpeak/?lis=" + sad_list.join(',') + "&ts=" + ts_list + '&during=' + during + "&emotion=sad",
            type: "GET",
            dataType:"json",
            success: function(data){
              if ( data != 'Null Data'){
              var isShift = false;
              for(var i in data){
                var x = data[i]['ts'];
                var title = data[i]['title'];
                //var happy_title = title['happy'];
                //var angry_title = title['angry'];
                var sad_title = title;
                var text = data[i]['text'];
                //var happy_text = text['happy'];
                //var angry_text = text['angry'];
                var sad_text = text;
                var flagClick = function(event){
                    var click_ts = this.x / 1000;
                    var emotion = this.emotion;
                    var title = this.title;
                    $.ajax({
                        url: "/moodlens/weibos_data/" + emotion + "/global/?ts=" + click_ts + "&during=" + during + '&limit=' + WEIBOS_LIMIT,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            $("#vertical-ticker").empty();
                            $("#event_title").html(title);
                            if(data[emotion].length>0){
                                chg_weibos(data[emotion]);
                            }
                            else{
                                $("#vertical-ticker").append("关键微博为空！");
                            }
                        }
                    });
                    $.ajax({
                        url: "/moodlens/keywords_data/global/?ts=" + click_ts + "&emotion=" + emotion+"&limit=" + KEYWORDS_LIMIT + "&during=" + during,
                        type: "GET",
                        dataType:"json",
                        success: function(data){
                            if(data=='search function undefined'){
                                $("#tags_ul").empty();
                                $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                redraw_tagcanvas();
                            }
                            else{
                                if(isEmptyObject(data[emotion])){
                                    $("#tags_ul").empty();
                                    $("#tags_ul").append("<li><a style='font-size:1ex'>关键词云数据为空</a></li>");
                                    redraw_tagcanvas();
                                }
                                else{
                                    chg_tagcloud(data[emotion]);
                                }
                            }
                        }
                    });
                    chg_emotion_pie(emotion_absolute[this.x]);     
                }
                series6.addPoint({'x': x, 'title': sad_title, 'text': sad_text, 'emotion': 'sad', 'events': {'click': flagClick}}, true, isShift);
              }

            }
        }
        })
    }

    /*function display_emotion_pie(data){
        Highcharts.setOptions({
            colors: ['#006600', '#FF0000', '#000099']
        });
        // Build the chart
        $('#emotion_pie_container').highcharts({
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
            },
            title: {
                text: '微博情绪饼图',
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        formatter:function(){
                            return '<b>'+this.point.name+'</b>'+this.percentage.toFixed(2)+'%';}

                    },
                    showInLegend: true
                }
            },
            navigation: {
                buttonOptions: {
                    verticalAlign: 'bottom',
                    y: -20
                }
            },
            series: [{
                type: 'pie',
                name: '情绪数值',
                data: data
            }]
        });
    }*/

    function display_realtime_emotion(){
        Highcharts.setOptions({
            global: {
                useUTC: false
            }
        });


        var chart_obj = $('#emotion_container').highcharts({
            chart: {
                type: 'line',//spline,
                animation: Highcharts.svg, // don't animate in old IE
                //marginTop: 20,
                marginRight: 10,
                //marginLeft: 10,
                events: {
                    load: function() {
                        var during = DURING_INTERGER;
                        var begin_ts = START_TS;
                        var end_ts = END_TS;
                        var total_nodes = (end_ts - begin_ts) / during;
                        var times_init = 0;

                        init_statistics(end_ts, end_ts - begin_ts);
                              
                        pull_emotion_count('global', total_nodes, times_init, begin_ts, during, this.series[0], this.series[1], this.series[2], this.series[3], this.series[4], this.series[5], this.series[6], this.series[7], this.series[8]);
                    }
                }
            },
            plotOptions:{
                line:{
                    events: {
                        legendItemClick: function () {
                            var seriesIndex = this.index;
                            series_flag[seriesIndex] = - series_flag[seriesIndex];
                            if(seriesIndex <= 2){
                                if(status_flag == 'absolute'){
                                    if(series_flag[seriesIndex] != series_flag[seriesIndex+6]){
                                        $(this.chart.series[seriesIndex+6].legendItem.element).trigger('click');
                                    }
                                }
                                else{
                                    if (series_flag[seriesIndex] != series_flag[seriesIndex+3]){
                                        $(this.chart.series[seriesIndex+3].legendItem.element).trigger('click');
                                    }
                                }
                            }
                        }
                    }
                }
            },
            title : {
                text: '微博情绪走势图'
            },

            rangeSelector: {
                selected: 4,
                inputEnabled: false,
                buttons: [{
                    type: 'week',
                    count: 1,
                    text: '1w'
                }, {
                    type: 'month',
                    count: 1,
                    text: '1m'
                }, {
                    type: 'month',
                    count: 3,
                    text: '3m'
                }]
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: '时间'
                },
                type: 'datetime',
                tickPixelInterval: 150
            },
            yAxis: {
                min: 0,
                title: {
                    text: '微 博 条 数'
                },
            },
            tooltip: {
                valueDecimals: 2,
                xDateFormat: '%Y-%m-%d %H:%M'
            },
            legend: {
                layout: 'horizontal',
                //verticalAlign: true,
                //floating: true,
                align: 'center', //'right',
                verticalAlign: 'bottom',
                x: 0,
                y: -2,
                borderWidth: 1,
                //enabled: true,
                //itemHiddenStyle: {
                    //color: 'white'
                //}
            },
            exporting: {
                enabled: true
            },
            series: [{
                name: '高兴',
                data: [],
                id: 'happy',
                color: '#006600',
                marker : {
                    enabled : false,    
                }
            },{
                name: '愤怒',
                data: [],
                id: 'angry',
                color: '#FF0000',
                marker : {
                    enabled : false,    
                }
            },{
                name: '悲伤',
                data: [],
                id: 'sad',
                color: '#000099',
                marker : {
                    enabled : false,    
                }
            },{
                name: '相对拐点(高兴)',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'happy',
                shape : 'circlepin',
                width : 2,
                color: '#006600'
            },{
                name: '相对拐点(愤怒)',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'angry',
                shape : 'circlepin',
                width : 2,
                color: '#FF0000'
            },{
                name: '相对拐点(悲伤)',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'sad',
                shape : 'circlepin',
                width : 2,
                color: '#000099'
            },{
                name: '绝对拐点(高兴)',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'happy',
                shape : 'circlepin',
                width : 2,
                color: '#006600',
                //visible:false
                showInLegend: false
            },{
                name: '绝对拐点(愤怒)',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'angry',
                shape : 'circlepin',
                width : 2,
                color: '#FF0000',
                //visible:false
                showInLegend: false
            },{
                name: '绝对拐点(悲伤)',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'sad',
                shape : 'circlepin',
                width : 2,
                color: '#000099',
                //visible:false
                showInLegend: false
            }]
        });

        
    }

    function load_absolute(){ 
        if(click_flag){
            var chart = $('#emotion_container').highcharts();
            chart.series[0].update({
                data : happy_absolute
            });
            chart.series[1].update({
                data : angry_absolute
            });
            chart.series[2].update({
                data : sad_absolute
            });

            chart.series[3].update({
                showInLegend: false
            });
            chart.series[4].update({
                showInLegend: false
            });
            chart.series[5].update({
                showInLegend: false
            });
            chart.series[6].update({
                showInLegend: true
            });
            chart.series[7].update({
                showInLegend: true
            });
            chart.series[8].update({
                showInLegend: true
            });
            chart.series[3].hide();
            chart.series[4].hide();
            chart.series[5].hide();
            chart.series[6].show();
            chart.series[7].show();
            chart.series[8].show();

            status_flag = 'absolute';

        }
        else{
            alert("请等待相对曲线加载完毕！");
        }
    }
    function load_relative(){
        var chart = $('#emotion_container').highcharts();
        chart.series[0].update({
            data : happy_ratio
        });
        chart.series[1].update({
            data : angry_ratio
        });
        chart.series[2].update({
            data : sad_ratio
        });
            chart.series[6].update({
                showInLegend: false
            });
            chart.series[7].update({
                showInLegend: false
            });
            chart.series[8].update({
                showInLegend: false
            });
            chart.series[3].update({
                showInLegend: true
            });
            chart.series[4].update({
                showInLegend: true
            });
            chart.series[5].update({
                showInLegend: true
            });
        chart.series[6].hide();
        chart.series[7].hide();
        chart.series[8].hide();
        chart.series[3].show();
        chart.series[4].show();
        chart.series[5].show();
        status_flag = 'relative';
       
    } 

</script>
</body>
</html>